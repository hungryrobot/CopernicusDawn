{% comment %}
Sales Rep Finder (Dawn 15+)
v2 – Territory groups + multicolumn-style cards + non-cropping banner
- Dropdown shows only TERRITORY GROUPS present in blocks (e.g., "Pacific Northwest")
- Selecting a group shows ALL reps with that group
- Big banner shows until a selection is made; scales to fit (no crop)
- No email/call buttons per spec
{% endcomment %}

<section class="rep-finder section-{{ section.id }}-padding">
  <div class="page-width">
    <div class="rep-finder__header">
      <h2 class="title">{{ section.settings.heading | default: "Find the sales representative in your territory." }}</h2>
    </div>

    {% assign banner_img = section.settings.banner_image %}
    {% assign banner_url = section.settings.banner_url %}
    <div id="RepBanner-{{ section.id }}" class="rep-finder__banner" {% if banner_img == blank and banner_url == blank %}style="display:none"{% endif %}>
      {% if banner_img != blank %}
        {{ banner_img | image_url: width: 2000 | image_tag: loading: 'lazy', alt: 'Sales representatives', class: 'rep-finder__banner-img' }}
      {% elsif banner_url != blank %}
        <img src="{{ banner_url | escape }}" alt="Sales representatives" loading="lazy" class="rep-finder__banner-img">
      {% endif %}
    </div>

    <div class="rep-finder__controls">
      <label class="visually-hidden" for="RepSelect-{{ section.id }}">Select territory</label>
      <select id="RepSelect-{{ section.id }}" class="select">
        <option value="__none__">{{ section.settings.placeholder | default: "— Select your territory —" }}</option>
      </select>
    </div>

    <div id="RepGrid-{{ section.id }}" class="rep-grid">
      {% for block in section.blocks %}
        {% if block.type == 'rep' %}
          {% assign group = block.settings.territory_group | strip %}
          <article class="rep-card" data-group="{{ group | escape }}" id="rep-{{ block.id }}" {{ block.shopify_attributes }} style="display:none;">
            <div class="rep-card__inner">
              <div class="rep-card__media">
                {% if block.settings.photo != blank %}
                  {{ block.settings.photo | image_url: width: 600 | image_tag: loading: 'lazy', alt: block.settings.name | escape }}
                {% elsif block.settings.photo_url != blank %}
                  <img src="{{ block.settings.photo_url | escape }}" alt="{{ block.settings.name | escape }}" loading="lazy">
                {% else %}
                  <div class="rep-card__placeholder">
                    {% assign initials = '' %}
                    {% assign parts = block.settings.name | upcase | split: ' ' %}
                    {% if parts.size > 0 %}{% assign initials = parts[0] | slice: 0,1 %}{% endif %}
                    {% if parts.size > 1 %}{% assign initials = initials | append: parts[1] | slice: 0,1 %}{% endif %}
                    {{ initials | default: "–" }}
                  </div>
                {% endif %}
              </div>
              <div class="rep-card__content">
                <h3 class="rep-card__title">{{ block.settings.name | default: "Sales Rep" }}</h3>
                {% if block.settings.group != blank %}
                  <div class="rep-card__subtitle text-subdued">{{ block.settings.group }}</div>
                {% endif %}
                {% if block.settings.coverage_display != blank %}
                  <div class="rep-card__territory"><strong>Territory:</strong> {{ block.settings.coverage_display }}</div>
                {% endif %}
              </div>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<style>
  /* Banner scales to fit (no cropping) */
  .rep-finder__banner { margin: 0 0 1rem; border-radius: 12px; overflow: hidden; }
  .rep-finder__banner-img { width: 100% !important; height: auto !important; object-fit: contain !important; display: block; }

  .rep-finder__controls { margin: 0 0 1rem; }

  /* Multicolumn-esque grid + cards */
  .rep-grid { display: grid; gap: 1.25rem; grid-template-columns: repeat(3, minmax(0, 1fr)); }
  @media (max-width: 990px) { .rep-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 750px) { .rep-grid { grid-template-columns: 1fr; } }

  .rep-card { background: #fff; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease; }
  .rep-card:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,.08); background: rgba(0,0,0,.02); }
  .rep-card__inner { display: grid; grid-template-columns: 88px 1fr; gap: 1rem; padding: 1rem; }
  .rep-card__media img { width: 88px; height: 88px; object-fit: cover; border-radius: 10px; display: block; }
  .rep-card__placeholder { width: 88px; height: 88px; border-radius: 10px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; }
  .rep-card__title { margin: .25rem 0 .25rem; font-size: 1.125rem; line-height: 1.3; }
  .rep-card__subtitle { margin: .15rem 0 .35rem; }
  .rep-card__territory { margin: .1rem 0 .25rem; }
  .text-subdued { color: #6b7280; }

  .visually-hidden{ position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
</style>

<script>
(function(){
  var rootId = "{{ section.id }}";
  var selectEl = document.getElementById("RepSelect-" + rootId);
  var grid = document.getElementById("RepGrid-" + rootId);
  var banner = document.getElementById("RepBanner-" + rootId);
  if(!selectEl || !grid) return;

  // Build unique list of territory groups from blocks
  var groupSet = new Set();
  grid.querySelectorAll(".rep-card").forEach(function(card){
    var g = (card.getAttribute("data-group") || "").trim();
    if(g) groupSet.add(g);
  });

  Array.from(groupSet).sort().forEach(function(g){
    var opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    selectEl.appendChild(opt);
  });

  function filter(group){
    var any = false;
    grid.querySelectorAll(".rep-card").forEach(function(card){
      var g = (card.getAttribute("data-group") || "").trim();
      var show = (group !== "__none__" && g === group);
      card.style.display = show ? "" : "none";
      if(show) any = true;
    });
    if(banner) banner.style.display = (group === "__none__" || !any) ? "" : "none";
  }

  selectEl.addEventListener("change", function(){ filter(this.value); });
  filter("__none__");
})();
</script>

{% schema %}
{
  "name": "Sales rep finder",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Find the sales representative in your territory." },
    { "type": "image_picker", "id": "banner_image", "label": "Banner image (shown before selection)" },
    { "type": "text", "id": "banner_url", "label": "Banner fallback URL (optional)" },
    { "type": "text", "id": "placeholder", "label": "Dropdown placeholder", "default": "— Select your territory —" }
  ],
  "blocks": [
    {
      "type": "rep",
      "name": "Rep",
      "settings": [
        { "type": "text", "id": "territory_group", "label": "Territory group (e.g., Pacific Northwest, New England)", "default": "Pacific Northwest" },
        { "type": "text", "id": "name", "label": "Name", "default": "Sales Rep" },
        { "type": "text", "id": "group", "label": "Group / Company (optional)" },
        { "type": "text", "id": "coverage_display", "label": "Coverage (display text)", "default": "WA, OR, ID" },
        { "type": "image_picker", "id": "photo", "label": "Square photo (optional)" },
        { "type": "text", "id": "photo_url", "label": "Photo URL (optional, used if no image chosen)" }
      ]
    }
  ],
  "enabled_on": { "templates": ["*"] },
  "presets": [
    {
      "name": "Sales rep finder (grouped)",
      "settings": {},
      "blocks": {
        "rep-1": { "type": "rep", "settings": { "territory_group": "Pacific Northwest", "name": "Sharon Van Pelt", "group": "Regional Rep", "coverage_display": "Idaho, Montana, Oregon, Washington, Wyoming" } },
        "rep-2": { "type": "rep", "settings": { "territory_group": "Pacific Northwest", "name": "Steve Kuta", "group": "Regional Rep", "coverage_display": "Colorado, Utah" } },
        "rep-3": { "type": "rep", "settings": { "territory_group": "New England", "name": "Anna Rainone", "group": "Independent Rep", "coverage_display": "Massachusetts, Maine, New Hampshire, Rhode Island, Vermont" } },
        "rep-4": { "type": "rep", "settings": { "territory_group": "New England", "name": "Zachary Levin", "group": "Independent Rep", "coverage_display": "Connecticut, Massachusetts, Maine, New Hampshire, Rhode Island, Vermont" } },
        "rep-5": { "type": "rep", "settings": { "territory_group": "Mid-Atlantic", "name": "Donna Reilly", "group": "Independent Rep", "coverage_display": "Maryland, Virginia, District of Columbia" } }
      },
      "block_order": ["rep-1","rep-2","rep-3","rep-4","rep-5"]
    }
  ]
}
{% endschema %}
